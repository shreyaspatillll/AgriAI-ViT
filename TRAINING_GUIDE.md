# AgriAI-ViT Training Guide

## Table of Contents
- [Overview](#overview)
- [Pre-Training Setup](#pre-training-setup)
- [Training Configuration](#training-configuration)
- [Model Training Process](#model-training-process)
- [Hyperparameter Tuning](#hyperparameter-tuning)
- [Experiment Tracking with Comet ML](#experiment-tracking-with-comet-ml)
- [Advanced Training Techniques](#advanced-training-techniques)
- [Training Best Practices](#training-best-practices)
- [Troubleshooting Training Issues](#troubleshooting-training-issues)

---

## Overview

This guide provides comprehensive instructions for training the Vision Transformer (ViT) model for crop disease detection in the AgriAI-ViT project.

### Training Objectives
- Achieve >95% validation accuracy on crop disease classification
- Minimize overfitting through proper regularization
- Optimize training time and resource utilization
- Track all experiments systematically using Comet ML

---

## Pre-Training Setup

### 1. Verify Dataset Preparation

```bash
# Check dataset structure
python scripts/verify_dataset.py --data_dir data/processed

# Expected output:
# ✓ Training set: 26,600 images across 38 classes
# ✓ Validation set: 5,700 images across 38 classes
# ✓ Test set: 5,700 images across 38 classes
# ✓ Class distribution balanced
```

### 2. Set Environment Variables

```bash
export COMET_API_KEY="your_api_key_here"
export COMET_PROJECT_NAME="agriai-vit"
export COMET_WORKSPACE="your_workspace"
export CUDA_VISIBLE_DEVICES=0
```

### 3. Verify GPU Setup

```bash
python -c "import torch; print(f'GPU: {torch.cuda.get_device_name(0)}'); \
           print(f'Memory: {torch.cuda.get_device_properties(0).total_memory / 1e9:.2f} GB')"
           ```

           ---

           ## Training Configuration

           ### Base Configuration (config/model_config.yaml)

           ```yaml
           # Model Architecture
           model:
             name: "vit_base_patch16_224"
               pretrained: true
                 pretrained_source: "imagenet21k"
                   num_classes: 38
                     image_size: 224
                       patch_size: 16
                         dropout: 0.1
                           attention_dropout: 0.1

                           # Training Parameters
                           training:
                             batch_size: 32
                               epochs: 30
                                 learning_rate: 3e-5
                                   weight_decay: 0.01
                                     early_stopping_patience: 5
                                       save_best_only: true

                                         # Optimizer Configuration
                                         optimizer:
                                           name: "AdamW"
                                             betas: [0.9, 0.999]
                                               eps: 1e-8

                                               # Learning Rate Scheduler
                                               scheduler:
                                                 name: "ReduceLROnPlateau"
                                                   mode: "min"
                                                     factor: 0.5
                                                       patience: 3
                                                         min_lr: 1e-7

                                                         # Data Augmentation
                                                         augmentation:
                                                           random_crop: true
                                                             horizontal_flip: true
                                                               rotation_range: 15
                                                                 brightness_range: [0.8, 1.2]
                                                                   contrast_range: [0.8, 1.2]

                                                                   # Loss Function
                                                                   loss:
                                                                     name: "CrossEntropyLoss"
                                                                       label_smoothing: 0.1
                                                                       ```

                                                                       ---

                                                                       ## Model Training Process

                                                                       ### Basic Training Command

                                                                       ```bash
                                                                       python scripts/train.py \
                                                                         --config config/model_config.yaml \
                                                                           --experiment_name "vit-base-run1" \
                                                                             --log_comet
                                                                             ```

                                                                             ### Training Script Structure

                                                                             ```python
                                                                             import torch
                                                                             import torch.nn as nn
                                                                             from torch.optim import AdamW
                                                                             from comet_ml import Experiment
                                                                             from src.models.vit_model import ViTModel
                                                                             from src.data.dataloader import get_dataloaders

                                                                             # Initialize Comet experiment
                                                                             experiment = Experiment(
                                                                                 api_key=os.getenv('COMET_API_KEY'),
                                                                                     project_name='agriai-vit',
                                                                                         workspace=os.getenv('COMET_WORKSPACE')
                                                                                         )

                                                                                         # Log hyperparameters
                                                                                         experiment.log_parameters({
                                                                                             'model': 'vit_base_patch16_224',
                                                                                                 'batch_size': 32,
                                                                                                     'learning_rate': 3e-5,
                                                                                                         'epochs': 30
                                                                                                         })
                                                                                                         
                                                                                                         # Load data
                                                                                                         train_loader, val_loader, test_loader = get_dataloaders(
                                                                                                             data_dir='data/processed',
                                                                                                                 batch_size=32,
                                                                                                                     num_workers=4
                                                                                                                     )
                                                                                                                     
                                                                                                                     # Initialize model
                                                                                                                     model = ViTModel(num_classes=38, pretrained=True)
                                                                                                                     model = model.to('cuda')
                                                                                                                     
                                                                                                                     # Setup optimizer and loss
                                                                                                                     optimizer = AdamW(model.parameters(), lr=3e-5, weight_decay=0.01)
                                                                                                                     criterion = nn.CrossEntropyLoss(label_smoothing=0.1)
                                                                                                                     scheduler = torch.optim.lr_scheduler.ReduceLROnPlateau(
                                                                                                                         optimizer, mode='min', factor=0.5, patience=3
                                                                                                                         )
                                                                                                                         
                                                                                                                         # Training loop
                                                                                                                         best_val_acc = 0.0
                                                                                                                         patience_counter = 0
                                                                                                                         
                                                                                                                         for epoch in range(30):
                                                                                                                             # Training phase
                                                                                                                                 model.train()
                                                                                                                                     train_loss = 0.0
                                                                                                                                         train_correct = 0
                                                                                                                                             train_total = 0
                                                                                                                                                 
                                                                                                                                                     for batch_idx, (images, labels) in enumerate(train_loader):
                                                                                                                                                             images, labels = images.to('cuda'), labels.to('cuda')
                                                                                                                                                                     
                                                                                                                                                                             optimizer.zero_grad()
                                                                                                                                                                                     outputs = model(images)
                                                                                                                                                                                             loss = criterion(outputs, labels)
                                                                                                                                                                                                     loss.backward()
                                                                                                                                                                                                             optimizer.step()
                                                                                                                                                                                                                     
                                                                                                                                                                                                                             train_loss += loss.item()
                                                                                                                                                                                                                                     _, predicted = outputs.max(1)
                                                                                                                                                                                                                                             train_total += labels.size(0)
                                                                                                                                                                                                                                                     train_correct += predicted.eq(labels).sum().item()
                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                     # Log batch metrics
                                                                                                                                                                                                                                                                             if batch_idx % 50 == 0:
                                                                                                                                                                                                                                                                                         experiment.log_metric('batch_loss', loss.item(), step=epoch*len(train_loader)+batch_idx)
                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                 train_acc = 100. * train_correct / train_total
                                                                                                                                                                                                                                                                                                     train_loss = train_loss / len(train_loader)
                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                             # Validation phase
                                                                                                                                                                                                                                                                                                                 model.eval()
                                                                                                                                                                                                                                                                                                                     val_loss = 0.0
                                                                                                                                                                                                                                                                                                                         val_correct = 0
                                                                                                                                                                                                                                                                                                                             val_total = 0
                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                     with torch.no_grad():
                                                                                                                                                                                                                                                                                                                                             for images, labels in val_loader:
                                                                                                                                                                                                                                                                                                                                                         images, labels = images.to('cuda'), labels.to('cuda')
                                                                                                                                                                                                                                                                                                                                                                     outputs = model(images)
                                                                                                                                                                                                                                                                                                                                                                                 loss = criterion(outputs, labels)
                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                         val_loss += loss.item()
                                                                                                                                                                                                                                                                                                                                                                                                                     _, predicted = outputs.max(1)
                                                                                                                                                                                                                                                                                                                                                                                                                                 val_total += labels.size(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                             val_correct += predicted.eq(labels).sum().item()
                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     val_acc = 100. * val_correct / val_total
                                                                                                                                                                                                                                                                                                                                                                                                                                                         val_loss = val_loss / len(val_loader)
                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # Log epoch metrics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     experiment.log_metrics({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             'train_loss': train_loss,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     'train_accuracy': train_acc,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             'val_loss': val_loss,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     'val_accuracy': val_acc,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             'learning_rate': optimizer.param_groups[0]['lr']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }, epoch=epoch)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         print(f'Epoch {epoch+1}/30 | Train Acc: {train_acc:.2f}% | Val Acc: {val_acc:.2f}%')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # Learning rate scheduling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     scheduler.step(val_loss)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # Early stopping and model saving
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if val_acc > best_val_acc:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         best_val_acc = val_acc
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 torch.save(model.state_dict(), 'models/checkpoints/best_model.pt')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         experiment.log_model('best_model', 'models/checkpoints/best_model.pt')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 patience_counter = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             patience_counter += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if patience_counter >= 5:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 print('Early stopping triggered')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             break
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             experiment.end()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ## Hyperparameter Tuning
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ### Learning Rate Tuning
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ```bash
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # Test different learning rates
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             for lr in 1e-5 3e-5 5e-5 1e-4; do
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               python scripts/train.py \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   --config config/model_config.yaml \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       --learning_rate $lr \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           --experiment_name "vit-lr-${lr}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ### Batch Size Optimization
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Find optimal batch size
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           batch_sizes = [16, 32, 64, 128]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           for bs in batch_sizes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               experiment = Experiment(project_name='agriai-vit')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   experiment.add_tag(f'batch_size_{bs}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Train with different batch size
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               train_loader = get_dataloaders(batch_size=bs)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # ... training code ...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ### Grid Search Configuration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ```yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   hyperparameter_search:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     learning_rate: [1e-5, 3e-5, 5e-5, 1e-4]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       weight_decay: [0.001, 0.01, 0.1]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         dropout: [0.1, 0.2, 0.3]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           batch_size: [16, 32, 64]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ## Experiment Tracking with Comet ML
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ### Initialize Experiment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           from comet_ml import Experiment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           experiment = Experiment(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               api_key=os.getenv('COMET_API_KEY'),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   project_name='agriai-vit',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       workspace=os.getenv('COMET_WORKSPACE')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Set experiment name and tags
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       experiment.set_name('vit-base-run1')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       experiment.add_tags(['vision-transformer', 'crop-disease', 'base-model'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ### Log Training Metrics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Log per-epoch metrics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       experiment.log_metrics({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           'train_loss': train_loss,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               'train_accuracy': train_acc,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   'val_loss': val_loss,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       'val_accuracy': val_acc
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }, epoch=epoch)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Log per-batch metrics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       experiment.log_metric('batch_loss', loss.item(), step=global_step)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ### Log Confusion Matrix
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       from sklearn.metrics import confusion_matrix
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       import seaborn as sns
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       import matplotlib.pyplot as plt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Get predictions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       y_true, y_pred = [], []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       for images, labels in val_loader:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           outputs = model(images.to('cuda'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               _, predicted = outputs.max(1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   y_true.extend(labels.numpy())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       y_pred.extend(predicted.cpu().numpy())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Create confusion matrix
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       cm = confusion_matrix(y_true, y_pred)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Plot and log
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       plt.figure(figsize=(15, 15))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       sns.heatmap(cm, annot=False, cmap='Blues')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       plt.title('Confusion Matrix')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       experiment.log_figure('confusion_matrix', plt)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ### Log Model Architecture
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Log model summary
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       experiment.log_parameter('total_params', sum(p.numel() for p in model.parameters()))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       experiment.log_parameter('trainable_params', sum(p.numel() for p in model.parameters() if p.requires_grad))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ## Advanced Training Techniques
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ### Mixed Precision Training
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       from torch.cuda.amp import autocast, GradScaler
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       scaler = GradScaler()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       for images, labels in train_loader:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           with autocast():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   outputs = model(images)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           loss = criterion(outputs, labels)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   scaler.scale(loss).backward()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       scaler.step(optimizer)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           scaler.update()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               optimizer.zero_grad()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ### Gradient Accumulation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               accumulation_steps = 4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               for i, (images, labels) in enumerate(train_loader):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   outputs = model(images)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       loss = criterion(outputs, labels) / accumulation_steps
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           loss.backward()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if (i + 1) % accumulation_steps == 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           optimizer.step()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   optimizer.zero_grad()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ### Transfer Learning Strategy
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # Freeze backbone, train only classifier
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   for param in model.backbone.parameters():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       param.requires_grad = False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Train for 5 epochs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       train(model, epochs=5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Unfreeze all layers
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       for param in model.parameters():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           param.requires_grad = True
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Fine-tune with lower learning rate
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           optimizer = AdamW(model.parameters(), lr=1e-5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           train(model, epochs=25)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ## Training Best Practices
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ### 1. Data Loading Optimization
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ```python
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           train_loader = DataLoader(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               dataset=train_dataset,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   batch_size=32,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       shuffle=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           num_workers=4,      # Use multiple workers
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               pin_memory=True,    # Speed up GPU transfer
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   persistent_workers=True  # Keep workers alive
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ### 2. Monitor GPU Utilization
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ```bash
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # Watch GPU usage during training
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   watch -n 1 nvidia-smi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ### 3. Checkpointing Strategy
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
